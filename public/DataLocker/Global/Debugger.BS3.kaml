<rbl-config></rbl-config>

<style>
/* Link Style */
/* Button Style */
{thisClass} .btn-primary,
{thisClass} .btn-danger,
{thisClass} .btn-default,
{thisClass} .btn-success,
{thisClass} .btn-info,
{thisClass} .btn-warning {
  -webkit-border-radius: 6px;
  -moz-border-radius: 6px;
  border-radius: 6px;
}
{thisClass} .btn-xs {
  -webkit-border-radius: 4px;
  -moz-border-radius: 4px;
  border-radius: 4px;
}

{thisClass} .rbl-logclass {
  padding: 0 20px;
  margin-bottom: 20px;
  border: solid 1px black;
  max-height: 160px;
  overflow-y: auto;
}

{thisClass} .toast {
  position: fixed;
  bottom: 5px;
  left: 2%;
  width: 50%;
  margin: 0 25% 0 25%;
  z-index: 999;
}
</style>

<div class="s">
    <div class="alert alert-info toast" style="display:none;" role="alert"></div>
</div>

<div class="rbl-nocalc">
    <div class="row">
        <div class="col-sm-12">
            <h3 class="mb-3">Options</h3>
        </div>
    </div>
    <div class="row">
        <div class="form-group vCustomView col-sm-6">
            <label for="" class="control-label lCustomView">Custom View</label>
            <div class="validator-container">
                <input name="CustomView" id="CustomView" type="text" placeholder="Folder:View, i.e. DST:FSA" class="form-control CustomView">
                <span class="error-msg" data-toggle="tooltip" data-placement="top"></span>
            </div>
        </div>
        <div class="form-group vKatAppSelector col-sm-6">
            <label for="" class="control-label lKatAppSelector">KatApp Selector To Override</label>
            <div class="validator-container">
                <input name="KatAppSelector" id="KatAppSelector" type="text" value=".katapp" placeholder="i.e. .katapp" class="form-control KatAppSelector">
                <span class="error-msg" data-toggle="tooltip" data-placement="top"></span>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="form-group vDataAttributes col-sm-6">
            <label for="" class="control-label lDataAttributes">Data Attributes To Apply...</label>
            <div class="validator-container">
                <input name="DataAttributes" id="DataAttributes" type="text" class="form-control DataAttributes">
                <span class="error-msg" data-toggle="tooltip" data-placement="top"></span>
            </div>
        </div>
        <div class="form-group vSaveCalcEngineLocation col-sm-6">
            <label for="" class="control-label lSaveCalcEngineLocation">Save Next Calculation To...</label>
            <div class="validator-container">
                <div class="input-group">
                    <input name="SaveCalcEngineLocation" id="SaveCalcEngineLocation" type="text" class="form-control SaveCalcEngineLocation">
                    <span class="input-group-btn">
                        <a class="btn btn-primary lnkSaveCalcEngine">Save</a>
                    </span>
                </div>
                <span class="error-msg" data-toggle="tooltip" data-placement="top"></span>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="form-group vSampleData col-sm-6">
            <label for="" class="control-label lSampleData">Sample Data (json)</label>
            <div class="validator-container">
                <input name="SampleData" id="SampleData" type="text" placeholder="paste json from DataSource" class="form-control SampleData">
                <span class="error-msg" data-toggle="tooltip" data-placement="top"></span>
            </div>
        </div>
        <div class="col-sm-3">
            <label data-info="spacer"></label>
            <div class="validator-container checkbox-container vUseTestPlugin">
                <span class="checkbox abc-checkbox UseTestPlugin lUseTestPlugin">
                    <input id="UseTestPlugin" type="checkbox" name="UseTestPlugin">
                    <label for="UseTestPlugin">Use test KatAppProvider version</label>
                </span>
            </div>
            <div class="validator-container checkbox-container vUseTestView">
                <span class="checkbox abc-checkbox UseTestView lUseTestView">
                    <input id="UseTestView" type="checkbox" name="UseTestView">
                    <label for="UseTestView">Use test View/Template versions</label>
                </span>
            </div>
        </div>
        <div class="col-sm-3">
            <label data-info="spacer"></label>
            <div class="validator-container checkbox-container vUseTestCalcEngine">
                <span class="checkbox abc-checkbox UseTestCalcEngine lUseTestCalcEngine">
                    <input id="UseTestCalcEngine" type="checkbox" name="UseTestCalcEngine">
                    <label for="UseTestCalcEngine">Use test CalcEngine</label>
                </span>
            </div>
            <div class="validator-container checkbox-container vUseLocalFiles hidden">
                <span class="checkbox abc-checkbox UseLocalFiles lUseLocalFiles">
                    <input id="UseLocalFiles" type="checkbox" name="UseLocalFiles">
                    <label for="UseLocalFiles">Use local View/Template files</label>
                </span>
            </div>
            <div class="validator-container checkbox-container vUseLocalProvider hidden">
                <span class="checkbox abc-checkbox UseLocalProvider lUseLocalProvider">
                    <input id="UseLocalProvider" type="checkbox" name="UseLocalProvider">
                    <label for="UseLocalProvider">Use local KatAppProvider file</label>
                </span>
            </div>
        </div>
        <div class="col-sm-12" style="padding-top: 10px;">
            <a class="btn btn-primary UpdateDebugOptions">Update</a>
            <a class="btn btn-primary LogResults">Log Calculation Info</a>
            <a class="btn btn-primary ConfigureUI">ConfigureUI Calculation</a>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-6" style="padding-top: 15px;">
            <div class="form-group vtraceLevel">
                <label for="traceLevel" class="control-label">Trace Verbosity</span> <a href="#" onclick="$('.rbl-logclass').empty();return false;">clear</a></label>
                <select name="traceLevel" id="traceLevel" class="form-control bootstrap-select show-tick traceLevel" tabindex="-98">
                    <option value="0" selected="true">None</option>
                    <option value="1">Quiet</option>
                    <option value="2">Minimal</option>
                    <option value="3">Normal</option>
                    <option value="4">Detailed</option>
                    <option value="5">Diagnostic</option>             
                </select>
            </div>
        </div>
        <div class="col-sm-12">
            <div class="rbl-logclass"></div>                    
        </div>
    </div>
</div>

<script>
    (function() {
        const view = $("{thisView}");

        if ( KatApp.pageParameters[ "debugkatapp"] === "1" ) {
            debugger;
        }

        view.on( "onInitialized.RBLe", function( event, application ) {
            const selectPickerAvailable = typeof $.fn.selectpicker === "function";

            if ( selectPickerAvailable ) {
                $(".bootstrap-select", view).selectpicker();
            }

            $(".KatAppSelector").val($(view).data("selector"));

            const getSelector = function() {
                return $(".KatAppSelector", view).val() || "[rbl-application-id]"; // Default to all katapps on page;
            }

            $("#traceLevel", view).change( function() {
                $(getSelector()).KatApp("updateOptions", { debug: { traceVerbosity: Number($("#traceLevel").val()) } });
            });
            
            $(".SaveCalcEngineLocation", view).bind("keyup.RBLe", function (e) {
                var keycode = (e.keyCode ? e.keyCode : e.which);
                if (keycode == 13) {
                    e.preventDefault();
                    $(".lnkSaveCalcEngine", view).trigger("click");
                }
            });
        
            $(".lnkSaveCalcEngine", view).click(function() {
                const location = $(".SaveCalcEngineLocation", view).val();

                if ( location !== "" ) {
                    $(getSelector()).KatApp("saveCalcEngine", location);
                    $(".SaveCalcEngineLocation", view).val("");

                    $(".toast", view).html("<p><b>Save Next CalcEngine...</b></p><p>Next calculation will be saved to " + location + " secure file location.</p>").slideDown();
                    window.setTimeout(function() {
                        $(".toast", view).slideUp();
                    }, 2500);
                }
            })

            $(".ConfigureUI", view).click( function() {
                $(getSelector()).KatApp("configureUI");
            });

            $(".LogResults", view).click( function () {
                $(getSelector()).each(function() {
                    const application = $(this).KatApp();

                    console.group("Application " + application.displayId + " Results");
                    console.log(application.results);
                    console.groupEnd("Application " + application.displayId + " Results");
                    console.group("Application " + application.displayId + " Inputs");
                    console.log(application.calculationInputs);
                    console.groupEnd("Application " + application.displayId + " Inputs");
                });
            });

            $(".UpdateDebugOptions", view).click(function() {
                const selector = getSelector();

                var initialSaveLocation = $(".SaveCalcEngineLocation", view).val() || "";
                $(".SaveCalcEngineLocation", view).val("");

                let calcEngine = undefined;
                let currentView = $(".CustomView", view).val() || "";
                const viewParts = currentView.split(">");
                if ( viewParts.length === 2 ) {
                    currentView = viewParts[ 0 ];
                    calcEngine = viewParts[ 1 ];
                }

                const debugOptions = { 
                    saveFirstCalculationLocation: initialSaveLocation !== "" ? initialSaveLocation : undefined,
                    refreshCalcEngine: true,
                    traceVerbosity: Number($("#traceLevel", view).val()),
                    useTestView: $("#UseTestView", view).prop("checked"),
                    useTestPlugin: $("#UseTestPlugin", view).prop("checked"),
                    useTestCalcEngine: $("#UseTestCalcEngine", view).prop("checked"),
                    debugResourcesDomain: false && $("#UseLocalFiles", view).prop("checked") ? "http://localhost:8887/" /* start at root of site */ : undefined,
                    debugProviderDomain: false && $("#UseLocalProvider", view).prop("checked") ? "http://localhost:8887/" /* start at root of site */ : undefined,                    
                };

                // Reset default options with options from UI
                KatApp.defaultOptions = KatApp.extend( KatApp.defaultOptions, { debug: debugOptions, functionUrl: KatApp.defaultOptions?.functionUrl ?? KatApp.functionUrl } );

                if ( currentView !== "" ) {
                    $(selector).KatApp("destroy"); // wouldn't need this usually on client site, but I'm going to reload/execute provider script so wanted everything destroyed
                    if ( typeof $.fn.selectpicker === "function" ) {
                        $(selector + " select.bootstrap-select").selectpicker("destroy");
                    }

                    var dataAttributes = $(".DataAttributes", view).val() || "";

                    $(selector).removeData().each(function() {
                        // get the native attributes object
                        var attrs = this.attributes;
                        var toRemove = [];

                        // iterate the attributes
                        for (attr in attrs) {
                            if ( typeof attrs[attr].name === 'string' && (/^data-/).test(attrs[attr].name) ) {
                                toRemove.push(attrs[attr].name);
                            }
                        }

                        // cache the jquery object containing the element for better performance
                        var element = $(this);
                        for (var i = 0; i < toRemove.length; i++) {
                            element.removeAttr(toRemove[i]);
                        }
                    });                

                    if ( dataAttributes !== "" ) {
                        dataAttributes.split(",").forEach( function( a ) {
                            const attrs = a.trim().split("=");
                            $(selector).attr("data-" + attrs[ 0 ], attrs[ 1 ]);
                        });
                    }

                    $(".DataAttributes", view).val("");
                    
                    const options = KatApp.extend( {}, KatApp.defaultOptions, { 
                        view: currentView,
                        getData: ($(".SampleData").val() || "" ) != ""
                            ? function( application, _options, done ) {    
                                application.trace("Using sample data from Debugger.kaml", TraceVerbosity.Normal);
                                done(JSON.parse($(".SampleData").val()));
                            }
                            : KatApp.defaultOptions.getData
                    } );

                    if ( calcEngine != undefined ) {
                        options.calcEngines = [ { name: calcEngine } ];
                    }

                    $.fn.KatApp.reset();

                    $(".logo-left").html("KatApp Test Harness: " + currentView);
                    $(selector).attr("rbl-trace-id", currentView.split(":")[1]).KatApp(options);
                }
                else {
                    $(selector).KatApp("updateOptions", { debug: debugOptions });
                }
            });

            $("#UseLocalFiles, #UseLocalProvider", view).prop("checked", KatApp.pageParameters[ "localdebugger"] === "1")
            $("#UseTestView", view).prop("checked", KatApp.pageParameters[ "testview"] === "1")
            $("#UseTestPlugin", view).prop("checked", KatApp.pageParameters[ "testplugin"] === "1")
            $("#UseTestCalcEngine", view).prop("checked", KatApp.pageParameters[ "test"] === "1")

            /*
            KatApp.defaultOptions.debug.refreshCalcEngine = true;
            KatApp.defaultOptions.debug.traceVerbosity = Number($("#traceLevel").val());
            
            if ( $("#UseLocalFiles", view).prop("checked") ) {
                KatApp.defaultOptions.debug.debugResourcesDomain = "http://localhost:8887/";
            }
            if ( $("#UseLocalProvider", view).prop("checked") ) {
                KatApp.defaultOptions.debug.debugProviderDomain = "http://localhost:8887/";
            } 
            */           
        });
    })();
    //# sourceURL=Debugger.kaml
</script>