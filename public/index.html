<!DOCTYPE html>
<html class="no-js">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<title>Decision Support Tools - Test Harness</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.css" integrity="sha256-fmMNkMcjSw3xcp9iuPnku/ryk9kaWgrEbfJfKmdZ45o=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" integrity="sha256-siyOpF/pBWUPgIcQi17TLBkjvNgNQArcmwJB8YvkAgg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/10.0.0/nouislider.css" integrity="sha256-FosuD4ZAGQFqGAUliYx0rX1BEMviGzI3I0pjy3uIryA=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.12/css/bootstrap-select.min.css" integrity="sha256-l3FykDBm9+58ZcJJtzcFvWjBZNJO40HmvebhpHXEhC0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesome-bootstrap-checkbox/0.3.7/awesome-bootstrap-checkbox.css" integrity="sha256-M9aoCVzUR/zsTFd2J1WmS91DpOOSbh3luX6xNnaY1QI=" crossorigin="anonymous" />
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" href="css/basic.bundle.kat.css" />
    <link rel="stylesheet" href="css/kat.test.harness.css" />
    <link rel="stylesheet" href="css/dst.css" />
</head>

<body id="myBody">
    <header class="header">
        <div class="container">
            <div class="logo-brand">
                <span class="logo logo-left">KatApp Test Harness</span>
                <span class="logo logo-right"></span>
            </div>
        </div>
    </header>

    <div class="page-content">
        <div class="container">
            <div class='KatApp' rbl-trace-id="1">Loading KatApp...</div>
        </div>

        <div class="s">
            <div class="alert alert-info toast" style="display:none;" role="alert"></div>
        </div>

        <div class="container">
            <div class="row">
                <div class="col-sm-12">
                    <h3 class="mb-3">Options</h3>
                </div>
                <div class="col-sm-6">
                    <div class="form-group vCurrentApp">
                        <label for="CurrentApp" class="control-label">Current Application</label>
                        <select name="CurrentApp" id="CurrentApp" class="form-control selectpicker show-tick CurrentApp" tabindex="-98">
                            <option value="DST:Disability" selected="true">DST - Disability</option>
                            <option value="DST:DevROI">DST - Dependent Eligibility Verification Savings Estimator</option>
                            <option value="DST:FSA">DST - FSA Tax Savings Calculator</option>
                        </select>
                    </div>
                    <div class="form-group vDataAttributes">
                        <label for="" class="control-label lDataAttributes">Data Attributes To Apply...</label>
                        <div class="validator-container">
                            <input name="DataAttributes" id="DataAttributes" type="text" class="form-control DataAttributes">
                            <span class="error-msg" data-toggle="tooltip" data-placement="top"></span>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group vSaveCalcEngineLocation">
                        <label for="" class="control-label lSaveCalcEngineLocation">Save Next Calculation To...</label>
                        <div class="validator-container">
                            <div class="input-group">
                                <input name="SaveCalcEngineLocation" id="SaveCalcEngineLocation" type="text" class="form-control SaveCalcEngineLocation">
                                <span class="input-group-btn">
                                    <a class="btn btn-primary lnkSaveCalcEngine">Save</a>
                                </span>
                            </div>
                            <span class="error-msg" data-toggle="tooltip" data-placement="top"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6 validator-container checkbox-container vUseTestPlugin">
                    <span class="checkbox abc-checkbox UseTestPlugin lUseTestPlugin">
                        <input id="UseTestPlugin" type="checkbox" name="UseTestPlugin">
                        <label for="UseTestPlugin">Use test PlugIn version</label>
                    </span>
                </div>
                <div class="col-sm-6 validator-container checkbox-container vUseTestView">
                    <span class="checkbox abc-checkbox UseTestView lUseTestView">
                        <input id="UseTestView" type="checkbox" name="UseTestView">
                        <label for="UseTestView">Use test View/Template versions</label>
                    </span>
                </div>
                <div class="col-sm-6 validator-container checkbox-container vUseTestCalcEngine">
                    <span class="checkbox abc-checkbox UseTestCalcEngine lUseTestCalcEngine">
                        <input id="UseTestCalcEngine" type="checkbox" name="UseTestCalcEngine">
                        <label for="UseTestCalcEngine">Use test CalcEngine</label>
                    </span>
                </div>
                <div class="col-sm-6 validator-container checkbox-container vUseLocalFiles">
                    <span class="checkbox abc-checkbox UseLocalFiles lUseLocalFiles">
                        <input id="UseLocalFiles" type="checkbox" name="UseLocalFiles" checked="checked">
                        <label for="UseLocalFiles">Use local View/Template files</label>
                    </span>
                </div>
                <div class="col-sm-12">
                    <a class="btn btn-primary UpdateDebugOptions">Update</a>
                    <a class="btn btn-primary LogResults">Log Results</a>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6" style="padding-top: 15px;">
                    <div class="form-group vtraceLevel">
                        <label for="traceLevel" class="control-label">Trace Verbosity</span> <a href="javascript:$('.rbl-logclass').empty();">clear</a></label>
                        <select name="traceLevel" id="traceLevel" class="form-control selectpicker show-tick traceLevel" tabindex="-98">
                            <option value="0">None</option>
                            <option value="1">Quiet</option>
                            <option value="2">Minimal</option>
                            <option value="3" selected="true">Normal</option>
                            <option value="4">Detailed</option>
                            <option value="5">Diagnostic</option>             
                        </select>
                    </div>
                </div>
                <div class="col-sm-12">
                    <div class="rbl-logclass"></div>                    
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container footer-links">
            <p>Copyrighted &copy; <span class="now-year">2016</span>. All rights reserved.</p>
        </div>    
    </footer>

    <!-- 3rd party cdn -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.js" integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI=" crossorigin="anonymous"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.js" integrity="sha256-Cr6N6zNN4bp0OwTQOZ6Z66M2r+2dpy/EwKMCyZ+SOMg=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js" integrity="sha256-bqVeqGdJ7h/lYPq6xrPv/YGzMEb6dNxlfiTUHSgRCp8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.12/js/bootstrap-select.min.js" integrity="sha256-+o/X+QCcfTkES5MroTdNL5zrLNGb3i4dYdWPWuq6whY=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/10.0.0/nouislider.js" integrity="sha256-qBtL4kx2JuCUQp1aTQxlcVxo58MxzFpmUS0WEl99kqw=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.7/highcharts.js" integrity="sha256-F0xKYvUdYPCgKKgKGtEjxwHXKSRbwKP+2mOlgGoR0Fs=" crossorigin="anonymous"></script>
    <script src="https://ajax.microsoft.com/ajax/4.0/1/MicrosoftAjax.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.matchHeight/0.7.2/jquery.matchHeight-min.js" integrity="sha256-+oeQRyZyY2StGafEsvKyDuEGNzJWAbWqiO2L/ctxF6c=" crossorigin="anonymous"></script>

    <!-- Katapp added -->
    <script src="js/KatApp.js"></script>

    <script>
        $( function() {
            // This used to be in Standard_Templates, copied from output from KAT asp.net site.  In reality,
            // it is up to the client to inject this (based on current culture).  The 'generic' template can't
            // know what culture to inject.  Could maybe have a rbl-culture on the KatApp div and then it could happen
            // in our 'js' code.  Need to decide how to handle this.  See `HighchartsCultureInfo` in Evolution site.
            Highcharts.setOptions({
                "lang": {
                "decimalPoint": ".",
                "thousandsSep": ",",
                "months": ["January", "February", "March", "April", "May", "June", "July", "August",
                    "September", "October", "November", "December", ""
                ],
                "shortMonths": ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov",
                    "Dec", ""
                ],
                "weekdays": ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                "shortWeekdays": ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]
                }
            });

            $("#traceLevel").selectpicker();
            $("#traceLevel").change( function() {
                $(".KatApp").KatApp("updateOptions", { debug: { traceVerbosity: Number($("#traceLevel").val()) } });
            });
            
            $(".SaveCalcEngineLocation").bind("keyup.RBLe", function (e) {
                var keycode = (e.keyCode ? e.keyCode : e.which);
                if (keycode == 13) {
                    e.preventDefault();
                    $(".lnkSaveCalcEngine").trigger("click");
                }
            });
        
            $(".lnkSaveCalcEngine").click(function() {
                const location = $(".SaveCalcEngineLocation").val();

                if ( location !== "" ) {
                    $(".KatApp").KatApp("saveCalcEngine", location);
                    $(".SaveCalcEngineLocation").val("");

                    $(".toast").html("<p><b>Save Next CalcEngine...</b></p><p>Next calculation will be saved to " + location + " secure file location.</p>").slideDown();
                    window.setTimeout(function() {
                        $(".toast").slideUp();
                    }, 2500);
                }
            })

            $(".LogResults").click( function () {
                $(".KatApp").each(function() {
                    const application = $(this).KatApp();

                    console.group("Application " + application.displayId + " Results");
                    console.log(application.results);
                    console.groupEnd("Application " + application.displayId + " Results");
                })                
            });

            $(".UpdateDebugOptions").click(function() {

                $(".KatApp").KatApp("destroy"); // wouldn't need this usually on client site, but I'm going to reload/execute provider script so wanted everything destroyed
                $(".KatApp select.bootstrap-select").selectpicker("destroy");

                var initialSaveLocation = $(".SaveCalcEngineLocation").val() || "";
                var dataAttributes = $(".DataAttributes").val() || "";

                $('.KatApp').removeData().each(function() {
                    // get the native attributes object
                    var attrs = this.attributes;
                    var toRemove = [];

                    // iterate the attributes
                    for (attr in attrs) {
                        if ( typeof attrs[attr].name === 'string' && (/^data-/).test(attrs[attr].name) ) {
                            toRemove.push(attrs[attr].name);
                        }
                    }

                    // cache the jquery object containing the element for better performance
                    var element = $(this);
                    for (var i = 0; i < toRemove.length; i++) {
                        element.removeAttr(toRemove[i]);
                    }
                });                

                if ( dataAttributes !== "" ) {
                    dataAttributes.split(",").forEach( function( a ) {
                        const attrs = a.trim().split(":");
                        $(".KatApp").attr("data-" + attrs[ 0 ], attrs[ 1 ]);
                    });
                }

                $(".SaveCalcEngineLocation, .DataAttributes").val("");

                const options = KatApp.extend( {}, KatApp.defaultOptions, { 
                        view: $("#CurrentApp").val(),
                        debug: { 
                            saveFirstCalculationLocation: initialSaveLocation !== "" ? initialSaveLocation : undefined,
                            refreshCalcEngine: true,
                            traceVerbosity: Number($("#traceLevel").val()),
                            useTestView: $("#UseTestView").prop("checked"),
                            useTestPlugin: $("#UseTestPlugin").prop("checked"),
                            useTestCalcEngine: $("#UseTestCalcEngine").prop("checked"),
                            debugResourcesRoot: $("#UseLocalFiles").prop("checked") ? "" /* start at root of site */ : undefined,
                        } 
                    } );

                // This is deleted each time the 'real' Provider js runs, so rebuild it and reset factory to shim factory
                $.fn.KatApp.plugInShims = [];
                $.fn.KatApp.applicationFactory = $.fn.KatApp.debugApplicationFactory;

                $(".logo-left").html("KatApp Test Harness: " + $("#CurrentApp option:selected").text());
                $(".KatApp").attr("rbl-trace-id", $("#CurrentApp").val().split(":")[1]).KatApp(options);
            });

            KatApp.defaultOptions.debug.refreshCalcEngine = true;
            KatApp.defaultOptions.debug.traceVerbosity = Number($("#traceLevel").val());

            if ( $("#UseLocalFiles").prop("checked") ) {
                KatApp.defaultOptions.debug.debugResourcesRoot = "";
            }
            
            // Access to XMLHttpRequest at 'https://qabtr.lifeatworkportal.com/Services/Evolution/CalculationFunction.ashx?{Command:%27KatAppResource%27,Resource:%27KatAppProvider.js%27,Folder:%27Global%27,Version:%27Live%27}' from origin 'http://localhost:1337' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
            KatApp.defaultOptions.functionUrl = "https://secure.conduentapplications.com/Services/RBL/Evolution/CalculationFunction.ashx";
            KatApp.defaultOptions.functionUrl = "http://localhost:54300/CalculationFunction.ashx";
            KatApp.defaultOptions.functionUrl = "https://secure.conduentapplications.com/Services/RBL/Evolution_Test/CalculationFunction.ashx";
            KatApp.defaultOptions.functionUrl = "https://btr.lifeatworkportal.com/Services/Evolution/CalculationFunction.ashx";

            $("#UseTestView").prop("checked", KatApp.pageParameters[ "testview"] === "1")
            $("#UseTestPlugin").prop("checked", KatApp.pageParameters[ "testplugin"] === "1")
            $("#UseTestCalcEngine").prop("checked", KatApp.pageParameters[ "test"] === "1")
            // saveFirstCalculationLocation: KatApp.pageParameters[ "save" ]

            $(".logo-left").html("KatApp Test Harness: " + $("#CurrentApp option:selected").text());
            $(".KatApp").attr("rbl-trace-id", $("#CurrentApp").val().split(":")[1]).KatApp( { view: $("#CurrentApp").val() } );
        });
    </script>

</body>

</html>
