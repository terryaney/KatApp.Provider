<html>
    <head>
        <title>Express Applications</title>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    </head>
    <body>
        <div class="container mt-3">
            <section class="col-md-12 mt-4 mb-5">
                <h3 class="mb-3">Welcome</h3>
                <div class="katapp startup" rbl-trace-id="1" rbl-view="global:app1.html" rbl-view-templates="standard_templates"></div>
                <div class="katapp startup" rbl-trace-id="2" rbl-calc-engine="Buck_ASU_SE">
                    <p class="myTitle" style="font-weight: bold;">Kat App View</p>
                    <label>Input 2</label>
                    <input id="input2" name="input2" class="input2" value="default2" />
                </div>
                <!--
                <div class="katapp" rbl-trace-id="3">
                    <p class="myTitle" style="font-weight: bold;">Kat App View</p>
                    <label>Input 3</label>
                    <input id="input3" name="input3" class="input3" value="default3" />
                </div>
                -->
            </section>
            <section class="col-md-12 mt-4 mb-5">
                <h3 class="mb-3">Logging</h3>
                <div class="rbl-logclass"></div>
            </section>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js" integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=" crossorigin="anonymous"></script>
        <script src="https://code.highcharts.com/highcharts.js"></script>
        <script src="js/KatApp.js"></script>

        <script>
            $( function() {
                KatApp.defaultOptions.enableTrace = true;
                KatApp.defaultOptions.useTestView = true;
                KatApp.defaultOptions.serviceUrl = "https://secure.conduentapplications.com/Services/RBL/Evolution_Test/Calculation.ashx";
                // KatApp.defaultOptions.serviceUrl = "http://localhost:3034/Calculation.ashx";

                // Override original then call it when you are done.  This is same as simply 
                // hooking to an event, just using a different syntax.  But needing to 
                // use call( this, ...) makes it kind of discouraging.  Not sure I even/even
                // use 'this' in the event handler, so could be moot and just use
                // originalCalcStart( application );
                var originalCalcStart = KatApp.defaultOptions.onCalculateStart;
                KatApp.defaultOptions.onCalculateStart = function( application ) {
                    application.trace( "Custom onCalculateStart");
                    originalCalcStart.call( this, application );
                };

                KatApp.defaultOptions.getRegistrationData = function( application, options, done, fail ) {
                    //this is a demo version that gets sample data from a REST API
                    const authId = KatApp.pageParameters["btrrest_testid"] || "911000011";
                    $.getJSON('https://qabtr.lifeatworkportal.com/services/rest/api/xds/TBOLoanPmtElection/' + authId )
                        .done(  xDataDef =>
                            {
                                application.trace( xDataDef );
                                application.trace( "Participant data retreived by BTR REST API" );
                                done( xDataDef );
                            }                         
                        )
                        .fail( fail );
                };

                // Just debug logging for any application initialized
                KatApp.defaultOptions.onInitialized = function( application ) {
                    application.trace("Application initialized.");
                    var id = application.element.attr("rbl-trace-id");
                    $(".myTitle", application.element).html("Kat App " + id + " - " + application.id);
                };
                KatApp.defaultOptions.onDestroyed = function( application ) {
                    application.trace("Application destroyed.");
                };

                $( "div.katapp.startup" ).KatApp( { 
                    runConfigureUICalculation: false,
                    onCalculation: function( results, options, application ) {    
                        var inputTrigger = application.inputs.iInputTrigger || "[Manual Calculation]";
                        application.trace(inputTrigger + " triggered calculation. Inputs Passed: " + Object.keys( application.inputs ).map( i => i + "=" + application.inputs[ i ] ).join( ", " ) + ".");
                    } 
                } );

                $("div.katapp:eq(2)").on( "onConfigureUICalculation.RBLe", function( event, calculationResults, calcOptions, application ) {
                    application.trace("<b>onConfigureUICalculation.RBLe Handler</b>: Called before calculationComplete. Inputs Passed: " + Object.keys( application.inputs ).map( i => i + "=" + application.inputs[ i ] ).join( ", " ) + ".")
                }).on( "onCalculation.RBLe", function( event, calculationResults, calcOptions, application ) {
                    var inputTrigger = calcOptions.inputs.iInputTrigger || "[Manual Calculation]";
                    application.trace("<b>Custom onCalculate.RBLe Handler</b>: Inputs Passed: " + Object.keys( application.inputs ).map( i => i + "=" + application.inputs[ i ] ).join( ", " ) + ".")
                }).KatApp();
            });
        </script>
    </body>
</html>